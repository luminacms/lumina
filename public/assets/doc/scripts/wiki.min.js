$(document).ready(function(){var e=$(window).width()-300,a=$(window).height();$(".editormd-body").css("width",e+"px").css("height",a+"px"),$("#tree-root .nav-item-content").css("height",a-100+"px"),$(window).resize(function(){a=$(window).height(),e=$(window).width()-300;var t=$(".editormd-toolbar").height();$(".editormd-body").css("width",e+"px").css("height",a+"px"),$("#tree-root .nav-item-content").css("margin-top",t+"px").css("height",a-100+"px")}),$("#create-document").click(function(){openCreateCatalogDialog()}),$("#create-document").tooltip({placement:"auto",placement:"left"}),$("[data-toggle='tooltip']").tooltip()}),function(e){e.isEditorChange=!1;var a,t=$("#btn-action"),o=($(e.top||e),$(e.top.document),$("#create-wiki")),n=o.find("#error-message");o.on("shown.bs.modal",function(){o.find("input[name='documentName']").focus()}),o.on("hidden.bs.modal",function(){t.button("reset")}),e.editor=editormd("editormd",{path:"/static/editormd/lib/",placeholder:"本编辑器支持Markdown编辑，左边编写，右边预览",imageUpload:!0,imageFormats:["jpg","jpeg","gif","png","JPG","JPEG","GIF","PNG"],imageUploadURL:"/upload",fileUpload:!0,htmlDecode:!0,fileUploadURL:"/upload",tocStartLevel:1,tocm:!0,toolbarIcons:["back","save","template","undo","redo","h1","h2","h3","h4","bold","hr","italic","quote","list-ul","list-ol","link","reference-link","image","file","code","html-entities","preformatted-text","code-block","table","history"],toolbarIconsClass:{bold:"fa-bold"},toolbarIconTexts:{bold:"a"},toolbarCustomIcons:{back:'<a href="javascript:;" title="返回"> <i class="fa fa-mail-reply" name="back"></i></a>',save:'<a href="javascript:;" title="保存" id="markdown-save" class="disabled"> <i class="fa fa-save" name="save"></i></a>',history:'<a href="javascript:;" title="历史版本"> <i class="fa fa-history" name="history"></i></a>',template:'<a href="javascript:;" title="模板"> <i class="fa fa-tachometer" name="template"></i></a>'},toolbarHandlers:{back:function(e,a,t,o){return document.referer?window.history.back():window.location="/member/projects",!1},save:function(e,a,t,o){$("#markdown-save").hasClass("change")&&$("#form-editormd").submit()},history:function(e,a,t,o){var n=$("#documentId").val();n?layer.open({type:2,title:"历史版本",shadeClose:!0,shade:.8,area:["700px","80%"],content:"/docs/history/"+n,end:function(){if(window.SelectedId){var e={node:{id:window.SelectedId}};window.loadDocument(e),window.SelectedId=null}}}):layer.msg("当前文档暂无历史版本")},template:function(e,a,t,o){$("#template-modal").modal("show")}},onload:function(){editor.setToolbarAutoFixed(!1);var e;$(".editormd-menu>li>a").hover(function(){var a=$(this).attr("title");e=layer.tips(a,this,{tips:3})},function(){layer.close(e)}),window.CONFIG.selected&&window.loadDocument(window.CONFIG.selected),initJsTree();var a={"Ctrl-S":function(e){$("#markdown-save").hasClass("change")&&$("#form-editormd").submit()},"Ctrl-A":function(e){e.execCommand("selectAll")}};this.addKeyMap(a)},onchange:function(){e.isEditorChange?e.isEditorChange=!1:$("#markdown-save").removeClass("disabled").addClass("change")}}),e.openCreateCatalogDialog=function(e){var a=e?e.id:0;o.find("input[name='id']").val(""),o.find("input[name='parentid']").val(a),o.find("input[name='documentName']").val(""),n.text(""),o.modal({show:!0})},e.deleteDocumentDialog=function(a){var t=layer.confirm("你确定要删除该文档吗？",{btn:["确定","取消"]},function(){$.post("/docs/delete/"+a.id).done(function(o){layer.close(t),0==o.errcode?(e.treeCatalog.delete_node(a),e.editor.clear()):layer.msg("删除失败",{icon:2})}).fail(function(){layer.close(t),layer.msg("删除失败",{icon:2})})})},e.editDocumentDialog=function(e){var a=e?e.id:0,t=e?e.text:"",d=e&&"#"!=e.parent?e.parent:0;o.find("input[name='id']").val(a),o.find("input[name='parentid']").val(d),o.find("input[name='documentName']").val(t),n.text(""),o.modal({show:!0})},e.getSiblingSort=function(e){var a=[];for(key in e.children){var t=a.length;a[t]={id:e.children[key],sort:key,parent:e.id}}return a},e.loadDocument=function(a){var t=layer.load(1,{shade:[.1,"#fff"]});$.get("/docs/content/"+a.node.id+"?dataType=json").done(function(o){e.isEditorChange=!0,layer.close(t),$("#documentId").val(a.node.id),window.editor.clear(),0==o.errcode&&o.data.doc.content?(window.editor.insertValue(o.data.doc.content),window.editor.setCursor({line:0,ch:0})):0!=o.errcode&&layer.msg("文档加载失败")}).fail(function(){layer.close(t),layer.msg("文档加载失败")})},o.find("#form-document").ajaxForm({type:"post",dataType:"json",beforeSubmit:function(a,d,i){var r=$(d).find("input[name='documentName']").val(),l=$(d).find("input[name='id']").val(),s=e.treeCatalog.get_node(l);return""==r?(n.text("文档名称不能为空"),!1):s&&s.text==r?(o.modal("hide"),!1):(t.button("loading"),!0)},success:function(a,d,i,r){if(t.button("reset"),0==a.errcode){var l={id:a.data.doc_id,parent:a.data.parent_id,text:a.data.name},s=e.treeCatalog.get_node(l.id);if(s)e.treeCatalog.rename_node({id:l.id},l.text);else{e.treeCatalog.create_node(a.data.parent_id,l,"last");e.treeCatalog.deselect_all(),e.treeCatalog.select_node(l),e.editor.clear()}$("#markdown-save").removeClass("change").addClass("disabled"),o.modal("hide")}else n.text(a.message)}}),$("#form-editormd").ajaxForm({dataType:"json",beforeSubmit:function(t,o,n){$("#markdown-save").removeClass("change").addClass("disabled");var d=$.trim(e.editor.getMarkdown()),i=$(o).find("input[name='doc_id']").val();return""===d?(layer.msg("保存成功"),!1):i?void(a=layer.load(1,{shade:[.1,"#fff"]})):(layer.msg("没有需要保存的文档"),!1)},success:function(e){0===e.errcode?($("#markdown-save").removeClass("change").addClass("disabled"),layer.close(a),layer.msg("文档已保存")):($("#markdown-save").removeClass("disabled").addClass("change"),layer.msg(e.message))}})}(window);